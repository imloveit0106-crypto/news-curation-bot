name: Daily News Curation

on:
  # æ¯Žæ—¥æœ8æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  # JST 8:00 = UTC 23:00 (å‰æ—¥)
  schedule:
    - cron: '0 23 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

  # PRã§ã‚‚ãƒ†ã‚¹ãƒˆã¨ã—ã¦å®Ÿè¡Œï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
  pull_request:
    branches: [master, main]

jobs:
  fetch-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      # å±¥æ­´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¾©å…ƒï¼ˆé‡è¤‡æŽ’é™¤ç”¨ï¼‰
      - name: Restore news history cache
        uses: actions/cache@v4
        with:
          path: data/history.json
          key: news-history-${{ github.ref_name }}
          restore-keys: |
            news-history-

      - name: Create data directory
        run: mkdir -p data

      - name: Fetch latest news
        id: news
        run: |
          echo "============================================"
          echo "  Daily News Curation Pro - $(date '+%Y-%m-%d %H:%M:%S') UTC"
          echo "  (Japan Time: $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S'))"
          echo "============================================"
          npm run start

      # å±¥æ­´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼ˆæ¬¡å›žå®Ÿè¡Œæ™‚ã«ä½¿ç”¨ï¼‰
      - name: Save news history cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/history.json
          key: news-history-${{ github.ref_name }}-${{ github.run_id }}

      # ç”Ÿæˆã•ã‚ŒãŸ docs/news.json ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push news.json
        if: github.event_name != 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/news.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“° Update news.json - $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M')"
            git push
          fi

      - name: Summary
        run: |
          echo "## ðŸ“° Daily News Report (Pro Edition)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time (JST):** $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Japanese & English sources" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Importance rating (ðŸ”¥ðŸ”¥ðŸ”¥ / ðŸ”¥ðŸ”¥)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deduplication (cached history)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sorted by importance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Auto-commit to docs/news.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Fetch latest news** step for full results." >> $GITHUB_STEP_SUMMARY
